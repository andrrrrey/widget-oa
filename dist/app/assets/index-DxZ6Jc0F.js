import{r as e,a as t}from"./vendor-9fiDQRhm.js";import{B as r,T as s,a as o,A as a,R as n,X as l}from"./ui-CX_COji7.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var i={exports:{}},c={},d=e,p=Symbol.for("react.element"),u=Symbol.for("react.fragment"),g=Object.prototype.hasOwnProperty,m=d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,h={key:!0,ref:!0,__self:!0,__source:!0};function f(e,t,r){var s,o={},a=null,n=null;for(s in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(n=t.ref),t)g.call(t,s)&&!h.hasOwnProperty(s)&&(o[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===o[s]&&(o[s]=t[s]);return{$$typeof:p,type:e,key:a,ref:n,props:o,_owner:m.current}}c.Fragment=u,c.jsx=f,c.jsxs=f,i.exports=c;var x,y=i.exports,b=t;x=b.createRoot,b.hydrateRoot;const w="undefined"!=typeof window&&window.__WIDGET_API_BASE__||"/api",v=({message:e,isStreaming:t,threadId:a,messageHistory:n=[],id:l})=>{const i="user"===e.role,c=async t=>{const r=n.slice(0,n.findIndex(t=>t.content===e.content)).reverse().find(e=>"user"===e.role);try{await fetch(`${w}/feedback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:a,messageOriginal:(null==r?void 0:r.content)||"",messageContent:e.content,feedbackType:t,id:l||null})})}catch(s){console.error("Error sending feedback:",s)}};return y.jsxs("div",{className:`flex gap-3 ${i?"flex-row-reverse":""} mb-4`,children:[!i&&y.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-gray-200",children:y.jsx(r,{className:"w-5 h-5 text-gray-700"})}),!i&&y.jsxs("div",{className:"max-w-[80%] flex flex-col group relative",children:[y.jsx("div",{className:"px-3 py-2 rounded-xl\n          bg-gray-100 text-gray-800\n          "+(t?"animate-pulse":""),children:y.jsx("p",{className:"whitespace-pre-wrap",children:e.content})}),y.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity delay-500 flex gap-1 absolute left-2 -bottom-6 px-2 py-1 bg-white rounded-lg shadow-md",children:[y.jsx("button",{onClick:e=>{c("up");const t=e.currentTarget;t.classList.add("-rotate-[20deg]"),setTimeout(()=>{var e;null==(e=t.parentElement)||e.remove()},500)},className:"p-1 hover:bg-gray-200 rounded-full transition-colors transform transition-transform duration-150","aria-label":"Thumbs up",children:y.jsx(s,{className:"w-4 h-4 text-gray-500"})}),y.jsx("button",{onClick:e=>{c("down");const t=e.currentTarget;t.classList.add("-rotate-[20deg]"),setTimeout(()=>{var e;null==(e=t.parentElement)||e.remove()},500)},className:"p-1 hover:bg-gray-200 rounded-full transition-colors transform transition-transform duration-150","aria-label":"Thumbs down",children:y.jsx(o,{className:"w-4 h-4 text-gray-500"})})]})]}),i&&y.jsx("div",{className:"max-w-[80%] px-3 py-2 rounded-xl\n          bg-blue-600 text-white\n          "+(t?"animate-pulse":""),children:y.jsx("p",{className:"whitespace-pre-wrap",children:e.content})})]})},j=({onSend:t,disabled:r,settings:s})=>{const[o,n]=e.useState(""),l=e.useRef(null);return y.jsx("form",{onSubmit:e=>{var s;e.preventDefault(),o.trim()&&!r&&(t(o),n(""),null==(s=l.current)||s.focus())},className:"p-4 bg-white",children:y.jsxs("div",{className:"flex items-center gap-2 rounded-xl\n        bg-gray-100 p-2",children:[y.jsx("input",{ref:l,type:"text",value:o,onChange:e=>n(e.target.value),placeholder:s.input_placeholder||"Введите ваш вопрос...",className:"flex-1 px-1 focus:outline-none bg-transparent"}),y.jsx("button",{type:"submit",disabled:r||!o.trim(),className:"p-2 rounded-xl bg-blue-600 text-white disabled:opacity-50 disabled:cursor-default disabled:pointer-events-none disabled:bg-gray-300 hover:bg-blue-700 transition-colors",children:y.jsx(a,{className:"w-4 h-4"})})]})})},_="Напишите мне — я подскажу по любому вопросу",N="chatThreadId",S="chatMessages";function E(){const t=()=>{var e;null==(e=d.current)||e.scrollIntoView({behavior:"smooth"})},[r,s]=e.useState(()=>{const e=localStorage.getItem(S);return e?JSON.parse(e):[]}),[o,a]=e.useState({welcome_text:"",title:"",show_poweredby:!0,input_placeholder:"Введите ваш вопрос...",loading_api:"Печатаю...",loading_openai:"Печатаю...",tooltip_reset:"Перезапустить чат",tooltip_close:"Закрыть чат",loading_app:"Загрузка чата..."}),[i,c]=e.useState(!1),d=e.useRef(null),[p,u]=e.useState(()=>localStorage.getItem(N)),[g,m]=e.useState(!0),[h,f]=e.useState(null),x=e.useRef(!1);if(e.useEffect(()=>{(async()=>{try{const e=new URLSearchParams(window.location.search).get("id");if(e){f(e);const t=await fetch(`${w}/settings?id=${e}`);if(!t.ok)throw new Error("Failed to load settings");const r=await t.json();a(r)}}catch{a({welcome_text:"",title:"",show_poweredby:!0,input_placeholder:"Введите ваш вопрос...",loading_api:"Печатаю...",loading_openai:"Печатаю...",tooltip_reset:"Перезапустить чат",tooltip_close:"Закрыть чат",loading_app:"Загрузка чата..."})}finally{m(!1),setTimeout(t,500)}})()},[]),e.useEffect(()=>{g||x.current||(r.length>0||s(e=>e.length>0?e:[...e,{role:"assistant",content:_}]),x.current=!0)},[g]),e.useEffect(()=>{setTimeout(t,100)},[r]),e.useEffect(()=>{localStorage.setItem(S,JSON.stringify(r))},[r]),g)return y.jsx("div",{className:"flex flex-col h-screen bg-white items-center justify-center",children:y.jsx("div",{className:"mt-4 text-gray-600",children:o.loading_app||"Loading chat..."})});return y.jsxs("div",{className:"flex flex-col h-screen bg-white",children:[y.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[y.jsxs("div",{children:[y.jsx("p",{className:"text-base text-gray-600",children:"Вас приветствует ИИ чат бот компании Loginof"}),o.title&&y.jsx("h1",{className:"text-xl font-semibold",children:o.title})]}),y.jsxs("div",{className:"flex gap-2",children:[y.jsxs("button",{onClick:()=>{s([]),u(null),localStorage.removeItem(N),localStorage.removeItem(S),x.current=!1,s([{role:"assistant",content:_}]),x.current=!0},className:"p-2 rounded-lg hover:bg-gray-100 transition-colors text-gray-300 hover:text-gray-800 relative group","aria-label":o.tooltip_reset,children:[y.jsx(n,{className:"w-5 h-5"}),y.jsx("span",{className:"z-10 absolute text-nowrap right-0 mt-3 opacity-0 group-hover:opacity-100 bg-gray-800 text-white text-xs py-1 px-2 rounded transition-opacity delay-500 pointer-events-none",children:o.tooltip_reset})]}),y.jsxs("button",{onClick:()=>{window.parent.postMessage("close-chat","*")},className:"p-2 rounded-lg hover:bg-gray-100 transition-colors relative group","aria-label":o.tooltip_close,children:[y.jsx(l,{className:"w-5 h-5"}),y.jsx("span",{className:"z-10 absolute text-nowrap right-0 mt-3 opacity-0 group-hover:opacity-100 bg-gray-800 text-white text-xs py-1 px-2 rounded transition-opacity delay-500 pointer-events-none",children:o.tooltip_close})]})]})]}),y.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[o.welcome_text&&y.jsx("div",{className:"text-center px-4 py-2 rounded-lg text-gray-600 mb-4",children:o.welcome_text}),r.map((e,t)=>y.jsx(v,{id:h,message:e,isStreaming:i&&t===r.length-1,threadId:p,messageHistory:r},t)),y.jsx("div",{ref:d})]}),y.jsx(j,{onSend:async e=>{var t;const r={role:"user",content:e};s(e=>[...e,r]),c(!0);try{const r={"Content-Type":"application/json"};p&&(r["x-thread-id"]=p);const n=new URLSearchParams(window.location.search).get("id")||null;s(e=>[...e,{role:"assistant",content:o.loading_api||"Печатаю..."}]);const l=null==(t=(await fetch(`${w}/chat`,{method:"POST",headers:r,body:JSON.stringify({message:e,widgetId:n,settings:o})})).body)?void 0:t.getReader();let i="";for(s(e=>{const t=[...e];return t[t.length-1]={role:"assistant",content:o.loading_openai||"Печатаю..."},t});l;){const{done:e,value:t}=await l.read();if(e)break;const r=(new TextDecoder).decode(t).split("\n\n");for(const o of r){if(!o.startsWith("data: "))continue;const e=o.slice(6);if("[DONE]"===e)break;try{const t=JSON.parse(e);t.content?(i+=t.content,s(e=>{const t=[...e];return t[t.length-1]={role:"assistant",content:i},t})):t.info&&(u(t.info.id),localStorage.setItem(N,t.info.id))}catch(a){console.error("Error parsing SSE message:",a)}}}}catch(n){console.error("Error:",n)}finally{c(!1)}},disabled:i,settings:{input_placeholder:o.input_placeholder}})]})}x(document.getElementById("root")).render(y.jsx(e.StrictMode,{children:y.jsx(E,{})}));
